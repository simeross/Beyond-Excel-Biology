{{ define "main" }}
<article class="blog-post">
    <header class="post-header">
        <h1>{{ .Title }}</h1>
        <div class="post-meta">
            <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2006-01-02" }}</time>
            {{ with .Params.tags }}
            <span class="tags">
                {{ range . }}
                <a href="{{ "tags/" | relURL }}{{ . | urlize }}" class="tag">#{{ . }}</a>
                {{ end }}
            </span>
            {{ end }}
        </div>
    </header>
    <div class="post-content">
        {{- $content := .Content -}}
        {{- $wikiLinkPattern := `\[\[([^\]]+)\]\]` -}}
        {{- range $match := findRE $wikiLinkPattern $content -}}
          {{- $linkContent := replaceRE `\[\[([^\]]+)\]\]` "$1" $match -}}
          {{- $parts := split $linkContent "|" -}}
          {{- $target := index $parts 0 -}}
          {{- $displayText := cond (gt (len $parts) 1) (index $parts 1) $target -}}
          
          {{- $slug := $target | urlize -}}
          {{- $page := $.Site.GetPage (printf "/posts/%s" $slug) -}}
          {{- if $page -}}
            {{- $replacement := printf `<a href="%s">%s</a>` $page.RelPermalink $displayText -}}
            {{- $content = replace $content $match $replacement -}}
          {{- else -}}
            {{- $replacement := printf `<span class="broken-link" title="Page not found: %s">%s</span>` $target $displayText -}}
            {{- $content = replace $content $match $replacement -}}
          {{- end -}}
        {{- end -}}
        {{ $content | safeHTML }}
    </div>
</article>
{{ end }}